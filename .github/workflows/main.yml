# .github/workflows/main.yml
name: Deploy Pro Blog to AWS
on:
  push:
    branches: [ main ]

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
  EC2_SERVER_IP: ${{ secrets.EC2_SERVER_IP }}
  EC2_USERNAME: ubuntu

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Configure AWS credentials on runner (for ECR push)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3) ECR login (runner)
      - name: Log in to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4) Build & push image
      - name: Build, tag, and push image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          set -euo pipefail
          echo "Building Docker image..."
          docker build -t "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" -f deployment/Dockerfile .

          echo "Pushing Docker image..."
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"

          echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      # 5) Copy compose/nginx to EC2
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.EC2_SERVER_IP }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deployment/docker-compose.yml,deployment/nginx.conf"
          target: "/home/ubuntu/pro-blog-aws"

      # 6) Prepare EC2 (idempotent install of AWS CLI, Docker, Compose v2)
      - name: Prepare EC2 (AWS CLI, Docker, Compose v2)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_SERVER_IP }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            # AWS CLI v2
            if ! command -v aws >/dev/null 2>&1; then
              echo "Installing AWS CLI v2..."
              sudo apt-get update -y
              sudo apt-get install -y unzip curl
              curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip -q awscliv2.zip
              sudo ./aws/install
              rm -rf aws awscliv2.zip
            fi
            aws --version || true

            # Docker Engine
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing Docker Engine..."
              sudo apt-get update -y
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi
            docker --version || true

            # Docker Compose v2 plugin
            if ! docker compose version >/dev/null 2>&1; then
              echo "Installing Docker Compose v2 plugin..."
              sudo mkdir -p /usr/lib/docker/cli-plugins
              ARCH=$(uname -m)
              if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
                URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64"
              else
                URL="https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-aarch64"
              fi
              sudo curl -fsSL "$URL" -o /usr/lib/docker/cli-plugins/docker-compose
              sudo chmod +x /usr/lib/docker/cli-plugins/docker-compose
            fi
            docker compose version || true

            # Docker group for ubuntu (takes effect next login; we still use sudo in this run)
            if ! id -nG ubuntu | grep -qw docker; then
              sudo usermod -aG docker ubuntu
            fi
            # Ensure app directory ownership
            sudo mkdir -p /home/ubuntu/pro-blog-aws
            sudo chown -R ubuntu:ubuntu /home/ubuntu/pro-blog-aws

      # 7) Deploy to EC2
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.EC2_SERVER_IP }}
          username: ${{ env.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail
            export ECR_REPO_URL_WITH_TAG='${{ steps.build-image.outputs.IMAGE_URI }}'
            export APP_DIR="/home/ubuntu/pro-blog-aws"
            export ECR_REGISTRY='${{ steps.login-ecr.outputs.registry }}'
            export AWS_REGION='${{ env.AWS_REGION }}'

            cd "$APP_DIR"

            echo "Fixing directory permissions..."
            sudo chown -R "$USER":"$USER" .

            echo "Logging in to ECR on the server..."
            aws ecr get-login-password --region "$AWS_REGION" | sudo docker login --username AWS --password-stdin "$ECR_REGISTRY"

            echo "Fetching secrets from AWS..."
            SECRET_KEY=$(aws secretsmanager get-secret-value --secret-id pro-blog/secret-key-v3 --query SecretString --output text --region "$AWS_REGION")
            DATABASE_URL=$(aws secretsmanager get-secret-value --secret-id pro-blog/database-url-v3 --query SecretString --output text --region "$AWS_REGION")

            echo "Writing .env.production..."
            sudo sh -c 'cat > .env.production <<EOF
            SECRET_KEY='"$SECRET_KEY"'
            DATABASE_URL='"$DATABASE_URL"'
            EOF'

            echo "Stopping old containers..."
            sudo docker compose down --remove-orphans || true

            echo "Pulling new image from ECR..."
            sudo docker pull "$ECR_REPO_URL_WITH_TAG"

            echo "Starting new containers..."
            sudo docker compose up --detach

            echo "Deploy complete."